---
- name: "Extract device and inventory data"
  set_fact:
    device: "{{ device_with_inventory[0] }}"
    inventory_response: "{{ device_with_inventory[1] }}"

- name: "Skip device if inventory collection failed"
  block:
    - name: "Parse inventory details"
      set_fact:
        inventory_data: "{{ inventory_response.json.value | default([]) }}"

    - name: "Extract specific inventory types"
      set_fact:
        processor_info: "{{ inventory_data | selectattr('InventoryType', 'eq', 'serverProcessors') | first | default({}) }}"
        memory_info: "{{ inventory_data | selectattr('InventoryType', 'eq', 'serverMemoryDevices') | first | default({}) }}"
        power_info: "{{ inventory_data | selectattr('InventoryType', 'eq', 'serverPowerSupplies') | first | default({}) }}"
        mgmt_info: "{{ inventory_data | selectattr('InventoryType', 'eq', 'deviceManagement') | first | default({}) }}"

    - name: "Calculate memory total"
      set_fact:
        total_memory_gb: >-
          {{
            (memory_info.InventoryInfo | default([]) |
            sum(attribute='size') | default(0) / 1024 / 1024 / 1024) | round(2)
          }}

    - name: "Transform to SunBird format"
      set_fact:
        sunbird_device:
          # Basic Information
          tiName: "{{ device.DeviceName | default('Unknown') }}"
          tiSerialNumber: "{{ device.DeviceServiceTag | default('') }}"
          cmbMake: "Dell"
          cmbModel: "{{ device.Model | default('Unknown') }}"
          cmbLocation: "{{ device.Location | default('Unknown') }}"
          
          # Status and Health
          tiDescription: "Dell PowerEdge via OME - Last Sync: {{ ansible_date_time.iso8601 }}"
          cfHealthState: "{{ device.Status | default('Unknown') }}"
          cfDeviceState: "{{ device.ConnectionState | default('Unknown') }}"
          cfPowerState: "{{ device.PowerState | default('Unknown') }}"
          
          # Hardware Details
          cfDeviceType: "{{ device.DeviceTypeName | default('Server') }}"
          cfServiceTag: "{{ device.DeviceServiceTag | default('') }}"
          cfAssetTag: "{{ device.AssetTag | default('') }}"
          cfProcessorCount: "{{ processor_info.InventoryInfo | default([]) | length }}"
          cfMemoryGiB: "{{ total_memory_gb }}"
          cfPowerSupplyCount: "{{ power_info.InventoryInfo | default([]) | length }}"
          
          # Network and Management
          cfIPAddress: "{{ mgmt_info.InventoryInfo[0].IpAddress | default('Unknown') }}"
          cfMacAddress: "{{ mgmt_info.InventoryInfo[0].MacAddress | default('Unknown') }}"
          
          # Integration Metadata
          cfOMEDeviceId: "{{ device.Id }}"
          cfDataSources: "ome"
          cfLastOMESync: "{{ ansible_date_time.iso8601 }}"
          cfCollectionTimestamp: "{{ ansible_date_time.epoch }}"

    - name: "Add device to SunBird list"
      set_fact:
        sunbird_devices: "{{ sunbird_devices + [sunbird_device] }}"

  when: inventory_response.status == 200
  rescue:
    - name: "Log failed device transformation"
      debug:
        msg: "Failed to transform device {{ device.DeviceName }} - skipping"
