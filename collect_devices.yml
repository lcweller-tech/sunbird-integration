---
- name: "Get all devices from OME"
  uri:
    url: "{{ ome_console_url }}{{ ome_api_base }}{{ ome_endpoints.devices }}"
    method: GET
    headers:
      Content-Type: "application/json"
      X-Auth-Token: "{{ ome_session_token }}"
    validate_certs: "{{ ome_validate_certs }}"
    timeout: "{{ ome_timeout }}"
  register: ome_devices_response
  retries: "{{ max_retries | default(3) }}"
  delay: "{{ retry_delay | default(10) }}"

- name: "Filter Dell PowerEdge servers"
  set_fact:
    dell_servers: >-
      {{
        ome_devices_response.json.value |
        selectattr('Type', 'in', include_device_types) |
        selectattr('Model', 'search', 'PowerEdge') |
        rejectattr('Status', 'in', exclude_device_states) |
        list
      }}

- name: "Display server discovery results"
  debug:
    msg: 
      - "Total devices in OME: {{ ome_devices_response.json.value | length }}"
      - "Dell PowerEdge servers found: {{ dell_servers | length }}"
      - "Servers will be processed in batches of {{ batch_size }}"

- name: "Fail if no servers found"
  fail:
    msg: "No Dell PowerEdge servers found in OME"
  when: dell_servers | length == 0
